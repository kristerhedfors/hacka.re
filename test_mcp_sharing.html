<!DOCTYPE html>
<html>
<head>
    <title>MCP Connection Sharing Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-results { margin: 20px 0; }
        .pass { color: green; }
        .fail { color: red; }
        .test-item { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>MCP Connection Sharing Implementation Test</h1>
    <div id="test-results"></div>
    
    <script>
        const results = [];
        
        function addResult(test, passed, message) {
            results.push({ test, passed, message });
            const resultsDiv = document.getElementById('test-results');
            const testItem = document.createElement('div');
            testItem.className = 'test-item';
            testItem.innerHTML = `
                <span class="${passed ? 'pass' : 'fail'}">
                    ${passed ? '✓' : '✗'} ${test}: ${message}
                </span>
            `;
            resultsDiv.appendChild(testItem);
        }
        
        function runTests() {
            console.log('Starting MCP Connection Sharing Tests...');
            
            // Test 1: Check if the MCP connections checkbox exists in the DOM
            const mcpCheckbox = document.getElementById('share-mcp-connections');
            if (mcpCheckbox) {
                addResult('MCP Checkbox DOM', true, 'MCP connections checkbox found in DOM');
            } else {
                addResult('MCP Checkbox DOM', false, 'MCP connections checkbox not found in DOM');
            }
            
            // Test 2: Check if ShareService.createComprehensiveShareableLink is async
            if (window.ShareService && typeof window.ShareService.createComprehensiveShareableLink === 'function') {
                addResult('ShareService Available', true, 'ShareService and createComprehensiveShareableLink method available');
            } else {
                addResult('ShareService Available', false, 'ShareService or createComprehensiveShareableLink not available');
            }
            
            // Test 3: Check if LinkSharingService supports MCP connections
            if (window.LinkSharingService && typeof window.LinkSharingService.extractSharedApiKey === 'function') {
                addResult('LinkSharingService Available', true, 'LinkSharingService available for MCP connection extraction');
            } else {
                addResult('LinkSharingService Available', false, 'LinkSharingService not available');
            }
            
            // Test 4: Check if SharedLinkDataProcessor has applyMcpConnections
            if (window.SharedLinkDataProcessor && typeof window.SharedLinkDataProcessor.applyMcpConnections === 'function') {
                addResult('MCP Data Processor', true, 'SharedLinkDataProcessor.applyMcpConnections method available');
            } else {
                addResult('MCP Data Processor', false, 'SharedLinkDataProcessor.applyMcpConnections not available');
            }
            
            // Test 5: Check if DOM elements are properly defined
            if (window.DOMElements) {
                const elements = window.DOMElements.getElements();
                if (elements.shareMcpConnectionsCheckbox) {
                    addResult('DOM Elements Integration', true, 'shareMcpConnectionsCheckbox properly defined in DOMElements');
                } else {
                    addResult('DOM Elements Integration', false, 'shareMcpConnectionsCheckbox not defined in DOMElements');
                }
            } else {
                addResult('DOM Elements Integration', false, 'DOMElements not available');
            }
            
            // Test 6: Test data flow simulation
            try {
                const testMcpData = {
                    mcpConnections: {
                        github: 'ghp_test123456789'
                    }
                };
                
                // This should not throw an error if our implementation is correct
                const hasValidStructure = testMcpData.mcpConnections && 
                                        typeof testMcpData.mcpConnections === 'object' &&
                                        testMcpData.mcpConnections.github;
                
                addResult('Data Structure Test', hasValidStructure, 'MCP connections data structure is valid');
            } catch (error) {
                addResult('Data Structure Test', false, `Error with data structure: ${error.message}`);
            }
            
            // Summary
            const passed = results.filter(r => r.passed).length;
            const total = results.length;
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'test-results';
            summaryDiv.innerHTML = `
                <h2>Test Summary</h2>
                <p><strong>${passed}/${total} tests passed</strong></p>
                ${passed === total ? 
                    '<p class="pass">✓ All tests passed! MCP connection sharing implementation appears to be working correctly.</p>' : 
                    '<p class="fail">✗ Some tests failed. Check the implementation.</p>'
                }
            `;
            document.body.appendChild(summaryDiv);
        }
        
        // Load the main application scripts first, then run tests
        function loadMainApp() {
            // Create a script tag to load the main app
            const script = document.createElement('script');
            script.src = 'index.html';
            script.onload = () => {
                setTimeout(runTests, 1000); // Give it time to initialize
            };
            script.onerror = () => {
                // If we can't load the full app, just run basic tests
                runTests();
            };
            document.head.appendChild(script);
        }
        
        // Start the test when page loads
        window.addEventListener('load', runTests);
    </script>
</body>
</html>