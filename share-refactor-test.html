<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share System Refactor Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #ffffff;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        
        .section {
            background: #2a2a2a;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        
        .checkbox-group {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
        }
        
        .checkbox-group label {
            cursor: pointer;
        }
        
        .sensitive-indicator {
            color: #ff9800;
            margin-left: 5px;
        }
        
        .link-length-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .link-length-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FFC107, #FF5722);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .link-length-fill.warning {
            background: #FFC107;
        }
        
        .link-length-fill.danger {
            background: #FF5722;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #333;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            color: #4CAF50;
            font-weight: bold;
        }
        
        .buttons {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
        }
        
        button:hover {
            background: #45a049;
        }
        
        .log-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .old-system, .new-system {
            padding: 15px;
            border-radius: 6px;
        }
        
        .old-system {
            background: #5d1e1e;
            border-left: 4px solid #f44336;
        }
        
        .new-system {
            background: #1e5d1e;
            border-left: 4px solid #4caf50;
        }
        
        .password-input {
            width: 100%;
            padding: 10px;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 5px;
            font-family: inherit;
            margin: 10px 0;
        }
        
        .message-history-container {
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }
        
        .message-history-container.active {
            opacity: 1;
        }
        
        .warning {
            background: #5d4e1e;
            border-left: 4px solid #ff9800;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Share System Refactor Test</h1>
            <p>Testing the new registry-based share system alongside the existing implementation</p>
        </div>

        <div class="section">
            <h2>üìä System Statistics</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-items">0</div>
                    <div>Total Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="selected-items">0</div>
                    <div>Selected Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="sensitive-items">0</div>
                    <div>Sensitive Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="plugins-count">0</div>
                    <div>Plugins</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>‚úÖ Share Items (Registry-Based)</h2>
            <div id="share-items-container">
                <!-- Share items will be populated here -->
                <div class="checkbox-group">
                    <input type="checkbox" id="share-base-url" class="share-checkbox">
                    <label for="share-base-url">Include Base URL</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="share-api-key" class="share-checkbox" checked>
                    <label for="share-api-key">Include API Key</label>
                    <span class="sensitive-indicator">üîí</span>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="share-model" class="share-checkbox">
                    <label for="share-model">Include Model</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="share-prompt-library" class="share-checkbox">
                    <label for="share-prompt-library">Include Prompt Library</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="share-function-library" class="share-checkbox">
                    <label for="share-function-library">Include Function Library</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="share-mcp-connections" class="share-checkbox">
                    <label for="share-mcp-connections">
                        Include MCP Connections
                        <span class="sensitive-indicator">üîí</span>
                    </label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="share-conversation" class="share-checkbox">
                    <label for="share-conversation">Include Conversation</label>
                </div>
                <div class="message-history-container">
                    <label for="message-history-count">Messages to include:</label>
                    <input type="number" id="message-history-count" value="10" min="1" max="100" disabled>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üìè Link Length Estimation</h2>
            <div>
                Estimated length: <span id="link-length-text">0</span> bytes
            </div>
            <div class="link-length-bar">
                <div class="link-length-fill" id="link-length-fill"></div>
            </div>
            <div id="link-length-warning" class="warning" style="display: none;">
                Link is getting long. Consider reducing shared data.
            </div>
        </div>

        <div class="section">
            <h2>üîë Password Generation</h2>
            <input type="password" id="share-password" class="password-input" placeholder="Generated password">
            <button id="generate-password">Generate New Password</button>
            <button id="toggle-password-visibility">üëÅÔ∏è Toggle Visibility</button>
        </div>

        <div class="section">
            <h2>üß™ Test Actions</h2>
            <div class="buttons">
                <button id="test-registry">Test Registry</button>
                <button id="test-plugins">Test Plugins</button>
                <button id="test-estimate">Estimate Size</button>
                <button id="test-validation">Validate Items</button>
                <button id="add-demo-plugin">Add Demo Plugin</button>
                <button id="setup-mcp">Setup MCP Connections</button>
                <button id="reset-to-defaults">Reset to Defaults</button>
            </div>
        </div>

        <div class="section">
            <h2>üìù Log Output</h2>
            <div id="log-output" class="log-output">
Ready for testing...
            </div>
        </div>

        <div class="section">
            <h2>üîÑ System Comparison</h2>
            <div class="comparison">
                <div class="old-system">
                    <h3>‚ùå Old System</h3>
                    <ul>
                        <li>Manual registration in 7+ files</li>
                        <li>Scattered size calculation logic</li>
                        <li>Direct DOM manipulation</li>
                        <li>Tight coupling between components</li>
                        <li>Difficult to add new items</li>
                        <li>No validation or error handling</li>
                    </ul>
                </div>
                <div class="new-system">
                    <h3>‚úÖ New System</h3>
                    <ul>
                        <li>Single registration call per item</li>
                        <li>Centralized size calculation</li>
                        <li>Component-based architecture</li>
                        <li>Loose coupling via registry</li>
                        <li>Plugin system for easy extension</li>
                        <li>Built-in validation and error handling</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üéØ Migration Status</h2>
            <div>
                <div>‚úÖ Phase 1: New system created alongside existing</div>
                <div>‚úÖ Phase 2: Existing items registered in new system</div>
                <div>‚úÖ Phase 3: UI components updated to use registry</div>
                <div>‚è≥ Phase 4: Remove old code after testing</div>
                <div>‚è≥ Phase 5: Document new plugin system</div>
            </div>
        </div>
    </div>

    <!-- Mock DOM elements that would normally exist -->
    <div style="display: none;">
        <input id="api-key" value="sk-test-api-key-12345">
        <input id="base-url" value="https://api.openai.com/v1">
        <select id="model">
            <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
        </select>
        <div id="share-qr-code-container"></div>
        <div id="qr-code-warning"></div>
        <div id="generated-link-container"></div>
        <form id="share-form"></form>
        <input id="share-welcome-message-checkbox" type="checkbox">
        <textarea id="share-welcome-message" placeholder="Welcome to hacka.re! Start a conversation with AI models." rows="3"></textarea>
        <input id="lock-session-key" type="checkbox">
        <div class="password-input-container"></div>
        <button id="toggle-password-visibility-btn"></button>
    </div>

    <script type="module">
        // Import the refactored system
        import { SHARE_CONFIG } from './js/config/share-config.js';
        import { getShareItemRegistry } from './js/services/share-item-registry.js';
        import { getSharePluginManager } from './js/plugins/share-plugin-manager.js';
        import { ShareServiceV2 } from './js/services/share-service-v2.js';
        import { ShareUIManagerV2 } from './js/components/ui/share-ui-manager-v2.js';
        import { initializeShareItemsRegistry } from './js/config/share-items-registry.js';
        import { GitHubTokenManager } from './js/components/mcp/github-token-manager.js';
        import { MCPConnectionsUI } from './js/components/mcp/mcp-connections-ui.js';

        // Initialize the system
        let registry, pluginManager, shareService, uiManager, githubManager, mcpUI;
        
        // Mock storage service for testing
        window.CoreStorageService = {
            async getValue(key) {
                const value = localStorage.getItem(`test_${key}`);
                return value ? JSON.parse(value) : null;
            },
            
            async setValue(key, value) {
                localStorage.setItem(`test_${key}`, JSON.stringify(value));
            },
            
            async removeValue(key) {
                localStorage.removeItem(`test_${key}`);
            }
        };

        // Mock Chat Manager
        window.ChatManager = {
            addSystemMessage(message) {
                log(`System: ${message}`);
            }
        };
        
        // Load MCP size estimator
        const mcpScript = document.createElement('script');
        mcpScript.src = './js/utils/mcp-size-estimator-global.js';
        document.head.appendChild(mcpScript);
        
        async function initialize() {
            try {
                log('üöÄ Initializing refactored share system...');
                
                // Initialize registry with existing items
                initializeShareItemsRegistry();
                registry = getShareItemRegistry();
                
                // Initialize plugin manager
                pluginManager = getSharePluginManager();
                
                // Initialize services
                shareService = new ShareServiceV2();
                
                // Initialize UI manager
                const elements = {
                    shareForm: document.getElementById('share-form'),
                    sharePassword: document.getElementById('share-password'),
                    shareWelcomeMessageCheckbox: document.getElementById('share-welcome-message-checkbox'),
                    shareWelcomeMessageInput: document.getElementById('share-welcome-message'),
                    lockSessionKeyCheckbox: document.getElementById('lock-session-key'),
                    passwordInputContainer: document.querySelector('.password-input-container'),
                    togglePasswordVisibilityBtn: document.getElementById('toggle-password-visibility-btn'),
                    messageHistoryCount: document.getElementById('message-history-count'),
                    messageHistoryContainer: document.querySelector('.message-history-container'),
                    linkLengthText: document.getElementById('link-length-text'),
                    linkLengthFill: document.getElementById('link-length-fill'),
                    linkLengthWarning: document.getElementById('link-length-warning'),
                    shareQrCodeContainer: document.getElementById('share-qr-code-container'),
                    qrCodeWarning: document.getElementById('qr-code-warning'),
                    generatedLinkContainer: document.getElementById('generated-link-container')
                };
                
                uiManager = new ShareUIManagerV2(elements);
                
                // Initialize MCP components
                githubManager = new GitHubTokenManager();
                await githubManager.initialize();
                
                mcpUI = new MCPConnectionsUI();
                await mcpUI.initialize();
                
                // Setup event listeners
                setupEventListeners();
                
                // Update statistics
                updateStatistics();
                
                // Generate initial password
                generatePassword();
                
                log('‚úÖ System initialized successfully!');
                log(`üìä Registry: ${registry.getStats().total} items registered`);
                log(`üîå Plugins: ${pluginManager.getStats().total} plugins loaded`);
                
            } catch (error) {
                log(`‚ùå Initialization failed: ${error.message}`, 'error');
            }
        }
        
        function setupEventListeners() {
            // Test buttons
            document.getElementById('test-registry').addEventListener('click', testRegistry);
            document.getElementById('test-plugins').addEventListener('click', testPlugins);
            document.getElementById('test-estimate').addEventListener('click', testEstimate);
            document.getElementById('test-validation').addEventListener('click', testValidation);
            document.getElementById('add-demo-plugin').addEventListener('click', addDemoPlugin);
            document.getElementById('setup-mcp').addEventListener('click', setupMCP);
            document.getElementById('reset-to-defaults').addEventListener('click', resetToDefaults);
            
            // Password buttons
            document.getElementById('generate-password').addEventListener('click', generatePassword);
            document.getElementById('toggle-password-visibility').addEventListener('click', togglePasswordVisibility);
            
            // Share checkboxes
            document.querySelectorAll('.share-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    updateStatistics();
                    updateLinkLength();
                });
            });
            
            // Message history
            document.getElementById('share-conversation').addEventListener('change', (e) => {
                const container = document.querySelector('.message-history-container');
                const input = document.getElementById('message-history-count');
                if (e.target.checked) {
                    container.classList.add('active');
                    input.disabled = false;
                } else {
                    container.classList.remove('active');
                    input.disabled = true;
                }
            });
        }
        
        function updateStatistics() {
            const stats = registry.getStats();
            const selected = registry.getSelected();
            const pluginStats = pluginManager.getStats();
            
            document.getElementById('total-items').textContent = stats.total;
            document.getElementById('selected-items').textContent = selected.length;
            document.getElementById('sensitive-items').textContent = stats.sensitive;
            document.getElementById('plugins-count').textContent = pluginStats.total;
        }
        
        async function updateLinkLength() {
            try {
                const totalSize = await shareService.estimateTotalSize();
                const percentage = Math.min(100, Math.round((totalSize / SHARE_CONFIG.MAX_LINK_LENGTH) * 100));
                
                document.getElementById('link-length-text').textContent = totalSize;
                
                const fill = document.getElementById('link-length-fill');
                fill.style.width = `${percentage}%`;
                
                const warning = document.getElementById('link-length-warning');
                if (totalSize > SHARE_CONFIG.MAX_LINK_LENGTH) {
                    fill.className = 'link-length-fill danger';
                    warning.style.display = 'block';
                    warning.textContent = `Link is too long (${totalSize} bytes). Consider reducing shared data.`;
                } else if (totalSize > SHARE_CONFIG.MAX_LINK_LENGTH * 0.8) {
                    fill.className = 'link-length-fill warning';
                    warning.style.display = 'block';
                    warning.textContent = `Link is getting long (${totalSize} bytes). Consider QR code limitations.`;
                } else {
                    fill.className = 'link-length-fill';
                    warning.style.display = 'none';
                }
            } catch (error) {
                log(`Error updating link length: ${error.message}`, 'error');
            }
        }
        
        function testRegistry() {
            log('üß™ Testing registry functionality...');
            const stats = registry.getStats();
            const selected = registry.getSelected();
            const all = registry.getAll();
            
            log(`Registry Stats: ${JSON.stringify(stats, null, 2)}`);
            log(`Selected Items: ${selected.length}`);
            selected.forEach(([id, config]) => {
                log(`  - ${id}: ${config.label} (${config.isSensitive ? 'sensitive' : 'public'})`);
            });
        }
        
        function testPlugins() {
            log('üîå Testing plugin functionality...');
            const plugins = pluginManager.getPlugins();
            const stats = pluginManager.getStats();
            
            log(`Plugin Stats: ${JSON.stringify(stats, null, 2)}`);
            plugins.forEach(plugin => {
                log(`  - ${plugin.id} v${plugin.version}: ${plugin.name}`);
            });
        }
        
        async function testEstimate() {
            log('üìè Testing size estimation...');
            try {
                const totalSize = await shareService.estimateTotalSize();
                const summary = shareService.getShareSummary();
                
                log(`Total estimated size: ${totalSize} bytes`);
                log(`Percentage of max: ${Math.round((totalSize / SHARE_CONFIG.MAX_LINK_LENGTH) * 100)}%`);
                log(`Selected items: ${summary.selectedItems}`);
                log(`Selected IDs: ${summary.selectedIds.join(', ') || 'None'}`);
            } catch (error) {
                log(`Error estimating size: ${error.message}`, 'error');
            }
        }
        
        async function testValidation() {
            log('‚úÖ Testing validation...');
            try {
                const errors = await uiManager.validateSelectedItems();
                if (errors.length === 0) {
                    log('All selected items are valid!');
                } else {
                    log(`Found ${errors.length} validation errors:`);
                    errors.forEach(error => log(`  - ${error}`));
                }
            } catch (error) {
                log(`Validation failed: ${error.message}`, 'error');
            }
        }
        
        function addDemoPlugin() {
            log('‚ûï Adding demo plugin...');
            
            const demoPlugin = pluginManager.createSimplePlugin({
                id: 'browser-info',
                label: 'Include Browser Info',
                priority: 85,
                sensitive: false,
                getData: async () => {
                    return {
                        userAgent: navigator.userAgent,
                        language: navigator.language,
                        platform: navigator.platform,
                        cookieEnabled: navigator.cookieEnabled,
                        onLine: navigator.onLine,
                        timestamp: Date.now()
                    };
                },
                setData: async (data) => {
                    log(`Received browser info: ${JSON.stringify(data, null, 2)}`);
                }
            });
            
            const success = pluginManager.registerPlugin(demoPlugin);
            if (success) {
                log('‚úÖ Demo plugin added successfully!');
                log('  - Checkbox automatically created');
                log('  - Size calculation integrated');
                log('  - No changes needed in other files');
                updateStatistics();
            } else {
                log('‚ùå Failed to add demo plugin', 'error');
            }
        }
        
        async function setupMCP() {
            log('üîå Setting up MCP connections...');
            try {
                await mcpUI.showConnectionsDialog();
                log('‚úÖ MCP connections dialog opened');
            } catch (error) {
                log(`‚ùå MCP setup error: ${error.message}`, 'error');
            }
        }
        
        function resetToDefaults() {
            log('üîÑ Resetting to defaults...');
            uiManager.setDefaultShareOptions();
            updateStatistics();
            updateLinkLength();
            log('Reset complete');
        }
        
        function generatePassword() {
            const password = shareService.generateStrongPassword();
            document.getElementById('share-password').value = password;
            log(`Generated new password: ${password}`);
        }
        
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('share-password');
            const button = document.getElementById('toggle-password-visibility');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                button.textContent = 'üôà Hide';
            } else {
                passwordInput.type = 'password';
                button.textContent = 'üëÅÔ∏è Show';
            }
        }
        
        function log(message, type = 'info') {
            const output = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
            
            // Also log to console
            console.log(`[ShareTest] ${message}`);
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initialize);
        
        // Make system available globally for debugging
        window.shareTest = {
            registry: () => registry,
            pluginManager: () => pluginManager,
            shareService: () => shareService,
            uiManager: () => uiManager,
            log
        };
    </script>
</body>
</html>