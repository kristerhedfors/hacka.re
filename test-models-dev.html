<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Models.dev Integration Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .model-result {
            margin: 10px 0;
            padding: 10px;
            background: #f5f5f5;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        h2 { margin-top: 30px; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th { background: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Models.dev Data Integration Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Models.dev Data Loading</h2>
        <div id="loading-test"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Context Window Lookups</h2>
        <div id="context-test"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Provider Detection</h2>
        <div id="provider-test"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 4: Model Search</h2>
        <div id="search-test"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 5: Integration with ModelInfoService</h2>
        <div id="integration-test"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 6: Context Extraction from Model IDs</h2>
        <div id="extraction-test"></div>
    </div>

    <!-- Load the services -->
    <script src="js/services/models-dev-data.js"></script>
    <script src="js/services/model-info.js"></script>
    
    <script>
        // Utility function to create result HTML
        function createResult(title, status, details) {
            return `<div class="model-result">
                <strong>${title}:</strong> 
                <span class="${status}">${status.toUpperCase()}</span>
                ${details ? `<br>${details}` : ''}
            </div>`;
        }
        
        // Wait for data to load
        setTimeout(() => {
            // Test 1: Check if data is loaded
            const loadingTest = document.getElementById('loading-test');
            if (window.ModelsDevData && window.ModelsDevData.modelsData) {
                const providers = Object.keys(window.ModelsDevData.modelsData);
                loadingTest.innerHTML = createResult(
                    'Data Loading',
                    'success',
                    `Loaded ${providers.length} providers: ${providers.slice(0, 10).join(', ')}...`
                );
            } else {
                loadingTest.innerHTML = createResult('Data Loading', 'error', 'ModelsDevData not loaded');
            }
            
            // Test 2: Context window lookups
            const contextTest = document.getElementById('context-test');
            const testModels = [
                { provider: 'openai', model: 'gpt-4', expected: 8192 },
                { provider: 'openai', model: 'gpt-4o', expected: 128000 },
                { provider: 'openai', model: 'gpt-4o-mini', expected: 128000 },
                { provider: 'openai', model: 'o1', expected: 200000 },
                { provider: 'groq', model: 'llama-3.3-70b-versatile', expected: 131072 },
                { provider: 'groq', model: 'mixtral-8x7b-32768', expected: 32768 }
            ];
            
            let contextHTML = '<table><tr><th>Provider</th><th>Model</th><th>Expected</th><th>Found</th><th>Status</th></tr>';
            testModels.forEach(test => {
                const context = window.ModelsDevData.getContextWindow(test.provider, test.model);
                const status = context === test.expected ? 'success' : (context ? 'info' : 'error');
                contextHTML += `<tr>
                    <td>${test.provider}</td>
                    <td>${test.model}</td>
                    <td>${test.expected}</td>
                    <td>${context || 'Not found'}</td>
                    <td class="${status}">${status.toUpperCase()}</td>
                </tr>`;
            });
            contextHTML += '</table>';
            contextTest.innerHTML = contextHTML;
            
            // Test 3: Provider detection
            const providerTest = document.getElementById('provider-test');
            const testUrls = [
                { url: 'https://api.openai.com/v1', expected: 'openai' },
                { url: 'https://api.groq.com/openai/v1', expected: 'groq' },
                { url: 'https://api.anthropic.com/v1', expected: 'anthropic' },
                { url: 'http://localhost:11434/v1', expected: 'ollama' },
                { url: 'https://api.berget.ai/v1', expected: 'inference' }
            ];
            
            let providerHTML = '<table><tr><th>URL</th><th>Expected Provider</th><th>Detected</th><th>Status</th></tr>';
            testUrls.forEach(test => {
                const provider = window.ModelsDevData.getProviderFromUrl(test.url);
                const status = provider === test.expected ? 'success' : 'error';
                providerHTML += `<tr>
                    <td>${test.url}</td>
                    <td>${test.expected}</td>
                    <td>${provider || 'None'}</td>
                    <td class="${status}">${status.toUpperCase()}</td>
                </tr>`;
            });
            providerHTML += '</table>';
            providerTest.innerHTML = providerHTML;
            
            // Test 4: Model search
            const searchTest = document.getElementById('search-test');
            const searchTerms = ['gpt-4', 'llama-3.3', 'claude', 'mixtral'];
            
            let searchHTML = '<table><tr><th>Search Term</th><th>Found</th><th>Provider</th><th>Context Window</th></tr>';
            searchTerms.forEach(term => {
                const result = window.ModelsDevData.searchModel(term);
                if (result) {
                    searchHTML += `<tr>
                        <td>${term}</td>
                        <td class="success">YES</td>
                        <td>${result.provider}</td>
                        <td>${result.model?.limit?.context || 'N/A'}</td>
                    </tr>`;
                } else {
                    searchHTML += `<tr>
                        <td>${term}</td>
                        <td class="error">NO</td>
                        <td>-</td>
                        <td>-</td>
                    </tr>`;
                }
            });
            searchHTML += '</table>';
            searchTest.innerHTML = searchHTML;
            
            // Test 5: Integration with ModelInfoService
            const integrationTest = document.getElementById('integration-test');
            if (window.ModelInfoService) {
                // Mock StorageService if needed
                if (!window.StorageService) {
                    window.StorageService = {
                        getBaseUrl: () => 'https://api.openai.com/v1'
                    };
                }
                
                const testIntegration = [
                    'gpt-4', 'gpt-4o', 'gpt-4o-mini', 'o1', 'o1-mini',
                    'llama-3.3-70b-versatile', 'mixtral-8x7b-32768'
                ];
                
                let integrationHTML = '<table><tr><th>Model</th><th>Context from ModelInfoService</th><th>Source</th></tr>';
                testIntegration.forEach(modelId => {
                    const context = window.ModelInfoService.getContextSize(modelId);
                    const source = context ? 'Found' : 'Not found';
                    integrationHTML += `<tr>
                        <td>${modelId}</td>
                        <td>${context || 'null'}</td>
                        <td class="${context ? 'success' : 'error'}">${source}</td>
                    </tr>`;
                });
                integrationHTML += '</table>';
                integrationTest.innerHTML = integrationHTML;
            } else {
                integrationTest.innerHTML = createResult('Integration', 'error', 'ModelInfoService not loaded');
            }
            
            // Test 6: Context extraction from model IDs
            const extractionTest = document.getElementById('extraction-test');
            if (window.ModelInfoService) {
                const testExtraction = [
                    { model: 'mixtral-8x7b-32768', expected: 32768 },
                    { model: 'llama-2-70b-4096', expected: 4096 },
                    { model: 'some-model-128000', expected: 128000 },
                    { model: 'gpt-4-32k', expected: 32768 },
                    { model: 'claude-100k', expected: 102400 },
                    { model: 'model-200k', expected: 204800 },
                    { model: 'deepseek-coder-33b-16384', expected: 16384 },
                    { model: 'yi-34b-200k', expected: 204800 },
                    { model: 'qwen-72b-32768', expected: 32768 },
                    { model: 'unknown-model-without-context', expected: null },
                    { model: 'model-999', expected: null }, // Too small to be context
                    { model: 'model-3000000', expected: null } // Too large to be realistic
                ];
                
                let extractionHTML = '<table><tr><th>Model ID</th><th>Expected</th><th>Extracted</th><th>Method</th><th>Status</th></tr>';
                testExtraction.forEach(test => {
                    // Store original values
                    const originalData = window.ModelsDevData.modelsData;
                    const originalHardcoded = window.ModelInfoService.contextWindowSizes[test.model];
                    
                    // Clear any existing data to test extraction only
                    window.ModelsDevData.modelsData = {}; // Temporarily clear models.dev data
                    delete window.ModelInfoService.contextWindowSizes[test.model]; // Remove hardcoded value if exists
                    
                    const context = window.ModelInfoService.getContextSize(test.model);
                    
                    // Determine which method was used
                    let method = 'pattern';
                    if (originalHardcoded) {
                        method = 'would be hardcoded';
                    }
                    
                    // Restore original values
                    window.ModelsDevData.modelsData = originalData;
                    if (originalHardcoded) {
                        window.ModelInfoService.contextWindowSizes[test.model] = originalHardcoded;
                    }
                    
                    const status = context === test.expected ? 'success' : 
                                  (context && test.expected ? 'info' : 
                                  (!context && !test.expected ? 'success' : 'error'));
                    
                    extractionHTML += `<tr>
                        <td>${test.model}</td>
                        <td>${test.expected || 'null'}</td>
                        <td>${context || 'null'}</td>
                        <td>${method}</td>
                        <td class="${status}">${status.toUpperCase()}</td>
                    </tr>`;
                });
                extractionHTML += '</table>';
                extractionTest.innerHTML = extractionHTML;
            } else {
                extractionTest.innerHTML = createResult('Extraction', 'error', 'ModelInfoService not loaded');
            }
            
        }, 2000); // Wait 2 seconds for data to load
    </script>
</body>
</html>