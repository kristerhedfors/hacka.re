<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Connector Integration Test</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 2rem;
            background-color: #f9fafb;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .service-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem;
        }
        .btn:hover {
            background: #4f46e5;
        }
        .status {
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .status.info {
            background: #dbeafe;
            color: #1e40af;
        }
        .result {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 4px;
            margin: 0.5rem 0;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Service Connector Integration Test</h1>
        <p>Test the GitHub, Gmail, and Google Docs integrations</p>

        <!-- GitHub Section -->
        <div class="service-section">
            <h2>GitHub Integration</h2>
            <div id="github-status" class="status info">Not connected</div>
            <button class="btn" onclick="testGitHubConnection()">Connect GitHub</button>
            <button class="btn" onclick="testGitHubListRepos()">List Repositories</button>
            <button class="btn" onclick="testGitHubGetUser()">Get User Info</button>
            <div id="github-result" class="result" style="display: none;"></div>
        </div>

        <!-- Gmail Section -->
        <div class="service-section">
            <h2>Gmail Integration</h2>
            <div id="gmail-status" class="status info">Not connected</div>
            <button class="btn" onclick="testGmailConnection()">Connect Gmail</button>
            <button class="btn" onclick="testGmailListMessages()">List Messages</button>
            <button class="btn" onclick="testGmailSearch()">Search Messages</button>
            <div id="gmail-result" class="result" style="display: none;"></div>
        </div>

        <!-- Google Docs Section -->
        <div class="service-section">
            <h2>Google Docs Integration</h2>
            <div id="gdocs-status" class="status info">Not connected</div>
            <button class="btn" onclick="testGdocsConnection()">Connect Google Docs</button>
            <button class="btn" onclick="testGdocsListDocs()">List Documents</button>
            <button class="btn" onclick="testGdocsCreateDoc()">Create Document</button>
            <div id="gdocs-result" class="result" style="display: none;"></div>
        </div>

        <!-- Service Status -->
        <div class="service-section">
            <h2>Service Status</h2>
            <button class="btn" onclick="checkAllServices()">Check All Services</button>
            <div id="service-status" class="result" style="display: none;"></div>
        </div>
    </div>

    <!-- Load required scripts -->
    <script src="js/utils/debug-service.js"></script>
    <script src="js/services/core-storage-service.js"></script>
    <script src="js/services/storage-service.js"></script>
    <!-- MCP Service Providers (refactored modular structure) -->
    <script src="js/services/mcp-providers/github-provider.js"></script>
    <script src="js/services/mcp-providers/gmail-provider.js"></script>
    <script src="js/services/mcp-providers/google-workspace-provider.js"></script>
    <script src="js/services/mcp-service-connectors-refactored.js"></script>

    <script>
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Service Connector Test Page loaded');
            updateServiceStatuses();
        });

        function updateStatus(serviceKey, status, message) {
            const statusEl = document.getElementById(`${serviceKey}-status`);
            if (statusEl) {
                statusEl.className = `status ${status}`;
                statusEl.textContent = message;
            }
        }

        function showResult(serviceKey, result) {
            const resultEl = document.getElementById(`${serviceKey}-result`);
            if (resultEl) {
                resultEl.style.display = 'block';
                resultEl.textContent = JSON.stringify(result, null, 2);
            }
        }

        function updateServiceStatuses() {
            if (window.MCPServiceConnectors) {
                const connectedServices = window.MCPServiceConnectors.getConnectedServices();
                const availableServices = window.MCPServiceConnectors.getAvailableServices();
                
                availableServices.forEach(service => {
                    const status = service.connected ? 'success' : 'info';
                    const message = service.connected ? 'Connected' : 'Not connected';
                    updateStatus(service.key, status, message);
                });
            } else {
                console.error('MCPServiceConnectors not available');
            }
        }

        // GitHub Tests
        async function testGitHubConnection() {
            try {
                updateStatus('github', 'info', 'Connecting...');
                const result = await window.MCPServiceConnectors.connectService('github');
                if (result) {
                    updateStatus('github', 'success', 'Connected successfully');
                    showResult('github', { success: true, message: 'GitHub connected' });
                } else {
                    updateStatus('github', 'error', 'Connection failed');
                }
            } catch (error) {
                updateStatus('github', 'error', `Error: ${error.message}`);
                showResult('github', { error: error.message });
            }
        }

        async function testGitHubListRepos() {
            try {
                const result = await window.MCPServiceConnectors.executeServiceTool('github', 'list_repos', {
                    type: 'all',
                    sort: 'updated',
                    per_page: 5
                });
                showResult('github', result);
                updateStatus('github', 'success', 'Repositories listed');
            } catch (error) {
                showResult('github', { error: error.message });
                updateStatus('github', 'error', `Error: ${error.message}`);
            }
        }

        async function testGitHubGetUser() {
            try {
                // Use GitHub API directly through our connector
                const result = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `Bearer ${await getStoredToken('github')}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                const data = await result.json();
                showResult('github', data);
                updateStatus('github', 'success', 'User info retrieved');
            } catch (error) {
                showResult('github', { error: error.message });
                updateStatus('github', 'error', `Error: ${error.message}`);
            }
        }

        // Gmail Tests
        async function testGmailConnection() {
            try {
                updateStatus('gmail', 'info', 'Connecting...');
                const result = await window.MCPServiceConnectors.connectService('gmail');
                if (result) {
                    updateStatus('gmail', 'success', 'Connected successfully');
                    showResult('gmail', { success: true, message: 'Gmail connected' });
                } else {
                    updateStatus('gmail', 'error', 'Connection failed');
                }
            } catch (error) {
                updateStatus('gmail', 'error', `Error: ${error.message}`);
                showResult('gmail', { error: error.message });
            }
        }

        async function testGmailListMessages() {
            try {
                const result = await window.MCPServiceConnectors.executeServiceTool('gmail', 'list_messages', {
                    maxResults: 5
                });
                showResult('gmail', result);
                updateStatus('gmail', 'success', 'Messages listed');
            } catch (error) {
                showResult('gmail', { error: error.message });
                updateStatus('gmail', 'error', `Error: ${error.message}`);
            }
        }

        async function testGmailSearch() {
            try {
                const result = await window.MCPServiceConnectors.executeServiceTool('gmail', 'search_messages', {
                    from: 'noreply@github.com',
                    hasAttachment: false
                });
                showResult('gmail', result);
                updateStatus('gmail', 'success', 'Search completed');
            } catch (error) {
                showResult('gmail', { error: error.message });
                updateStatus('gmail', 'error', `Error: ${error.message}`);
            }
        }

        // Google Docs Tests
        async function testGdocsConnection() {
            try {
                updateStatus('gdocs', 'info', 'Connecting...');
                const result = await window.MCPServiceConnectors.connectService('gdocs');
                if (result) {
                    updateStatus('gdocs', 'success', 'Connected successfully');
                    showResult('gdocs', { success: true, message: 'Google Docs connected' });
                } else {
                    updateStatus('gdocs', 'error', 'Connection failed');
                }
            } catch (error) {
                updateStatus('gdocs', 'error', `Error: ${error.message}`);
                showResult('gdocs', { error: error.message });
            }
        }

        async function testGdocsListDocs() {
            try {
                const result = await window.MCPServiceConnectors.executeServiceTool('gdocs', 'list_documents', {
                    maxResults: 10,
                    orderBy: 'modifiedTime'
                });
                showResult('gdocs', result);
                updateStatus('gdocs', 'success', 'Documents listed');
            } catch (error) {
                showResult('gdocs', { error: error.message });
                updateStatus('gdocs', 'error', `Error: ${error.message}`);
            }
        }

        async function testGdocsCreateDoc() {
            try {
                const result = await window.MCPServiceConnectors.executeServiceTool('gdocs', 'create_document', {
                    title: 'Test Document from hacka.re',
                    content: 'This is a test document created by the hacka.re service connector integration.'
                });
                showResult('gdocs', result);
                updateStatus('gdocs', 'success', 'Document created');
            } catch (error) {
                showResult('gdocs', { error: error.message });
                updateStatus('gdocs', 'error', `Error: ${error.message}`);
            }
        }

        // Utility functions
        async function getStoredToken(serviceKey) {
            if (window.StorageService) {
                return await window.StorageService.getValue(`mcp_${serviceKey}_token`);
            }
            return null;
        }

        async function checkAllServices() {
            const statusEl = document.getElementById('service-status');
            statusEl.style.display = 'block';
            
            const status = {
                serviceConnectors: !!window.MCPServiceConnectors,
                storageService: !!window.StorageService,
                connectedServices: [],
                availableServices: []
            };

            if (window.MCPServiceConnectors) {
                status.connectedServices = window.MCPServiceConnectors.getConnectedServices();
                status.availableServices = window.MCPServiceConnectors.getAvailableServices();
            }

            statusEl.textContent = JSON.stringify(status, null, 2);
        }
    </script>
</body>
</html>