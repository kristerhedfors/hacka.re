<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Link Password Fix Test</title>
    <style>
        body { 
            font-family: monospace; 
            padding: 20px; 
            background: #1a1a1a;
            color: #0f0;
        }
        .test {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #0f0;
            background: #0a0a0a;
        }
        .result { color: #ff0; font-weight: bold; }
        .success { color: #0f0; }
        .error { color: #f00; }
        button { padding: 10px; margin: 5px; }
    </style>
</head>
<body>
    <h1>üîó Shared Link Password Fix Test</h1>
    <div id="output"></div>

    <script src="lib/tweetnacl/nacl-fast.min.js"></script>
    <script src="lib/tweetnacl/nacl-util.min.js"></script>
    <script src="js/utils/crypto-utils.js"></script>
    <script src="js/utils/compression-utils-simple.js"></script>
    <script src="js/services/link-sharing-service.js"></script>
    
    <script>
        const output = document.getElementById('output');
        
        function log(message, className = '') {
            const div = document.createElement('div');
            div.className = `test ${className}`;
            div.innerHTML = message;
            output.appendChild(div);
        }
        
        async function testSharedLinkCreation() {
            log("<h2>Testing Shared Link Creation and Extraction</h2>");
            
            try {
                // Test data with large repetitive content for compression
                const testData = {
                    apiKey: "sk-test-key-12345",
                    welcomeMessage: "Hello! ".repeat(100), // Should compress well
                    model: "gpt-5-nano",
                    messages: [
                        { role: "user", content: "Test message" },
                        { role: "assistant", content: "Test response" }
                    ]
                };
                
                const password = "test123";
                
                log("Creating shared link with compression...");
                const shareableLink = await LinkSharingService.createCustomShareableLink(testData, password);
                
                log(`<span class="result">Generated link length: ${shareableLink.length} characters</span>`);
                log(`Link preview: ${shareableLink.substring(0, 100)}...`);
                
                // Extract the encrypted portion
                const hashPart = shareableLink.split('#gpt=')[1];
                if (!hashPart) {
                    log('<span class="error">‚ùå No encrypted data found in link</span>');
                    return;
                }
                
                log("Testing extraction with correct password...");
                
                // Create a mock location object for testing
                const mockLocation = {
                    hash: `#gpt=${hashPart}`,
                    href: shareableLink
                };
                
                // Set up testing objects
                LinkSharingService._setTestingObjects(mockLocation, {});
                
                // Try to extract
                const extractedData = await LinkSharingService.extractSharedApiKey(password);
                
                if (extractedData) {
                    log('<span class="success">‚úÖ Successfully extracted data!</span>');
                    log(`API Key: ${extractedData.apiKey}`);
                    log(`Model: ${extractedData.model}`);
                    log(`Welcome Message Length: ${extractedData.welcomeMessage ? extractedData.welcomeMessage.length : 'None'}`);
                    log(`Messages Count: ${extractedData.messages ? extractedData.messages.length : 'None'}`);
                    
                    // Verify data integrity
                    const isValid = extractedData.apiKey === testData.apiKey &&
                                   extractedData.model === testData.model &&
                                   extractedData.welcomeMessage === testData.welcomeMessage;
                    
                    if (isValid) {
                        log('<span class="success">‚úÖ Data integrity verified!</span>');
                    } else {
                        log('<span class="error">‚ùå Data integrity check failed!</span>');
                    }
                } else {
                    log('<span class="error">‚ùå Failed to extract data</span>');
                }
                
                // Test with wrong password
                log("Testing extraction with wrong password...");
                const wrongResult = await LinkSharingService.extractSharedApiKey("wrong123");
                if (!wrongResult) {
                    log('<span class="success">‚úÖ Correctly rejected wrong password</span>');
                } else {
                    log('<span class="error">‚ùå Should have rejected wrong password</span>');
                }
                
                // Reset testing objects
                LinkSharingService._resetTestingObjects();
                
            } catch (error) {
                log(`<span class="error">‚ùå Error: ${error.message}</span>`);
                console.error('Test error:', error);
            }
        }
        
        // Run the test
        testSharedLinkCreation();
    </script>
</body>
</html>