<!DOCTYPE html>
<html>
<head>
    <title>Namespace Refactor Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .pass { background: #d4edda; }
        .fail { background: #f8d7da; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>Namespace Service Refactor Test</h1>
    <div id="results"></div>
    
    <button onclick="testSharedLinkScenario()">Test Shared Link Scenario</button>
    <button onclick="testCrossTabSync()">Test Cross-Tab Sync</button>
    <button onclick="clearAll()">Clear All</button>
    
    <script>
        const results = document.getElementById('results');
        
        function log(message, isPass = true) {
            const div = document.createElement('div');
            div.className = 'test ' + (isPass ? 'pass' : 'fail');
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            results.appendChild(div);
        }
        
        async function testSharedLinkScenario() {
            log('Starting shared link scenario test...');
            
            // Simulate shared link master key
            window._sharedLinkMasterKey = 'test-master-key-123';
            
            // Load the namespace service
            await loadScript('/js/services/namespace-service.js');
            
            // Ensure the shared link master key is cached
            const cached = window.NamespaceService.ensureSharedLinkMasterKeyCached();
            log(`Master key cached: ${cached}`);
            
            // Get current master key
            const masterKey = window.NamespaceService.getCurrentMasterKey();
            log(`Current master key available: ${!!masterKey}`);
            
            // Simulate namespace reset (like during cross-tab sync)
            window.NamespaceService.resetNamespaceCache();
            
            // Check if master key is still available
            const masterKeyAfterReset = window.NamespaceService.getCurrentMasterKey();
            log(`Master key after reset: ${!!masterKeyAfterReset}`, !!masterKeyAfterReset);
            
            // Simulate reinitialize
            window.NamespaceService.reinitializeNamespace();
            
            // Check if master key is still available
            const masterKeyAfterReinit = window.NamespaceService.getCurrentMasterKey();
            log(`Master key after reinitialize: ${!!masterKeyAfterReinit}`, !!masterKeyAfterReinit);
        }
        
        function testCrossTabSync() {
            log('Testing cross-tab sync scenario...');
            
            // Simulate storage event from another tab
            const event = new StorageEvent('storage', {
                key: 'hackare_sync_trigger',
                newValue: JSON.stringify({
                    type: 'message_added',
                    timestamp: Date.now(),
                    namespaceId: 'test-namespace'
                })
            });
            
            window.dispatchEvent(event);
            log('Dispatched cross-tab sync event');
        }
        
        function clearAll() {
            results.innerHTML = '';
            window._sharedLinkMasterKey = null;
            log('Cleared all test data');
        }
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
    </script>
</body>
</html>