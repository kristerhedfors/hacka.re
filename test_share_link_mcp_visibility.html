<!DOCTYPE html>
<html>
<head>
    <title>Test Share Link MCP Visibility</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        .test-section { margin: 20px 0; padding: 10px; border: 1px solid #0f0; }
        .success { color: #0f0; }
        .error { color: #f00; }
        .info { color: #ff0; }
        button { margin: 10px; padding: 5px 10px; }
        pre { background: #000; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Share Link MCP Visibility Test</h1>
    
    <div class="test-section">
        <h2>Test Steps:</h2>
        <ol>
            <li>Enable Share Link MCP</li>
            <li>Check if functions are registered</li>
            <li>Open Functions modal</li>
            <li>Check if functions are visible in UI</li>
        </ol>
    </div>
    
    <div class="test-section">
        <h2>Actions:</h2>
        <button onclick="enableShareLinkMCP()">1. Enable Share Link MCP</button>
        <button onclick="checkFunctionsRegistered()">2. Check Functions Registered</button>
        <button onclick="openFunctionsModal()">3. Open Functions Modal</button>
        <button onclick="checkFunctionsInUI()">4. Check Functions in UI</button>
        <button onclick="disableShareLinkMCP()">5. Disable Share Link MCP</button>
        <button onclick="runFullTest()">Run Full Test</button>
    </div>
    
    <div class="test-section">
        <h2>Results:</h2>
        <pre id="results"></pre>
    </div>
    
    <script>
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const className = type;
            results.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            console.log(`[${type}] ${message}`);
        }
        
        async function enableShareLinkMCP() {
            log('Enabling Share Link MCP...', 'info');
            
            // Navigate to main page in iframe to interact with it
            const iframe = document.createElement('iframe');
            iframe.src = 'http://localhost:8000';
            iframe.style.width = '100%';
            iframe.style.height = '600px';
            document.body.appendChild(iframe);
            
            iframe.onload = async () => {
                const iframeWindow = iframe.contentWindow;
                
                // Wait for the app to initialize
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Enable Share Link MCP
                if (iframeWindow.MCPShareLinkUI) {
                    await iframeWindow.MCPShareLinkUI.enableShareLinkMCP();
                    log('✅ Share Link MCP enabled', 'success');
                    
                    // Check if functions were registered
                    const functions = iframeWindow.FunctionToolsService.getJsFunctions();
                    const shareLinkFunctions = Object.keys(functions).filter(name => 
                        name.includes('share_link')
                    );
                    
                    if (shareLinkFunctions.length > 0) {
                        log(`✅ Found ${shareLinkFunctions.length} Share Link functions: ${shareLinkFunctions.join(', ')}`, 'success');
                    } else {
                        log('❌ No Share Link functions found in registry', 'error');
                    }
                    
                    // Check if UI was refreshed
                    const functionList = iframeWindow.document.getElementById('function-list');
                    if (functionList) {
                        const shareLinkCollection = functionList.querySelector('[data-collection-id="mcp_share_link"]');
                        if (shareLinkCollection) {
                            log('✅ Share Link MCP collection visible in UI', 'success');
                            const functionItems = shareLinkCollection.querySelectorAll('.function-item');
                            log(`   Found ${functionItems.length} function items in the collection`, 'info');
                        } else {
                            log('❌ Share Link MCP collection NOT visible in UI', 'error');
                            log('   Available collections:', 'info');
                            const allCollections = functionList.querySelectorAll('[data-collection-id]');
                            allCollections.forEach(col => {
                                log(`   - ${col.dataset.collectionId}`, 'info');
                            });
                        }
                    } else {
                        log('⚠️ Function list element not found (modal might not be open)', 'info');
                    }
                    
                } else {
                    log('❌ MCPShareLinkUI not found', 'error');
                }
            };
        }
        
        function checkFunctionsRegistered() {
            const iframe = document.querySelector('iframe');
            if (!iframe) {
                log('❌ No iframe found. Run step 1 first.', 'error');
                return;
            }
            
            const iframeWindow = iframe.contentWindow;
            const functions = iframeWindow.FunctionToolsService.getJsFunctions();
            const shareLinkFunctions = Object.keys(functions).filter(name => 
                name.includes('share_link')
            );
            
            log(`Checking registered functions...`, 'info');
            if (shareLinkFunctions.length > 0) {
                log(`✅ ${shareLinkFunctions.length} Share Link functions registered:`, 'success');
                shareLinkFunctions.forEach(func => {
                    const enabled = iframeWindow.FunctionToolsService.isJsFunctionEnabled(func);
                    log(`   - ${func}: ${enabled ? 'ENABLED' : 'DISABLED'}`, enabled ? 'success' : 'info');
                });
            } else {
                log('❌ No Share Link functions found in registry', 'error');
            }
            
            // Check collections
            const collections = iframeWindow.FunctionToolsService.getAllFunctionCollections();
            const shareLinkCollection = collections['mcp_share_link'];
            if (shareLinkCollection) {
                log('✅ Share Link collection found in registry', 'success');
                log(`   Collection metadata: ${JSON.stringify(shareLinkCollection.metadata)}`, 'info');
            } else {
                log('❌ Share Link collection NOT found in registry', 'error');
            }
        }
        
        function openFunctionsModal() {
            const iframe = document.querySelector('iframe');
            if (!iframe) {
                log('❌ No iframe found. Run step 1 first.', 'error');
                return;
            }
            
            const iframeWindow = iframe.contentWindow;
            
            log('Opening Functions modal...', 'info');
            
            // Open the Functions modal
            if (iframeWindow.aiHackare && iframeWindow.aiHackare.functionCallingManager) {
                iframeWindow.aiHackare.functionCallingManager.showFunctionModal();
                log('✅ Functions modal opened', 'success');
            } else {
                log('❌ Could not open Functions modal', 'error');
            }
        }
        
        function checkFunctionsInUI() {
            const iframe = document.querySelector('iframe');
            if (!iframe) {
                log('❌ No iframe found. Run step 1 first.', 'error');
                return;
            }
            
            const iframeWindow = iframe.contentWindow;
            const iframeDocument = iframe.contentDocument;
            
            log('Checking Functions modal UI...', 'info');
            
            const functionModal = iframeDocument.getElementById('function-modal');
            if (!functionModal || !functionModal.classList.contains('active')) {
                log('❌ Functions modal is not open. Run step 3 first.', 'error');
                return;
            }
            
            const functionList = iframeDocument.getElementById('function-list');
            if (!functionList) {
                log('❌ Function list element not found', 'error');
                return;
            }
            
            // Look for Share Link MCP collection
            const shareLinkCollection = functionList.querySelector('[data-collection-id="mcp_share_link"]');
            if (shareLinkCollection) {
                log('✅ Share Link MCP collection FOUND in UI!', 'success');
                
                // Get collection details
                const collectionHeader = shareLinkCollection.querySelector('.function-collection-header h4');
                const collectionName = collectionHeader ? collectionHeader.textContent : 'Unknown';
                log(`   Collection name: ${collectionName}`, 'info');
                
                // Count functions
                const functionItems = shareLinkCollection.querySelectorAll('.function-item');
                log(`   Number of functions: ${functionItems.length}`, 'info');
                
                // List functions
                functionItems.forEach(item => {
                    const nameEl = item.querySelector('.function-item-name');
                    const checkbox = item.querySelector('.function-item-checkbox');
                    const name = nameEl ? nameEl.textContent : 'Unknown';
                    const enabled = checkbox ? checkbox.checked : false;
                    log(`   - ${name}: ${enabled ? 'ENABLED' : 'DISABLED'}`, enabled ? 'success' : 'info');
                });
            } else {
                log('❌ Share Link MCP collection NOT FOUND in UI', 'error');
                
                // List all collections found
                const allCollections = functionList.querySelectorAll('[data-collection-id]');
                if (allCollections.length > 0) {
                    log(`   Found ${allCollections.length} other collections:`, 'info');
                    allCollections.forEach(col => {
                        const header = col.querySelector('.function-collection-header h4');
                        const name = header ? header.textContent : col.dataset.collectionId;
                        log(`   - ${name} (${col.dataset.collectionId})`, 'info');
                    });
                } else {
                    log('   No collections found in UI', 'error');
                }
            }
        }
        
        async function disableShareLinkMCP() {
            const iframe = document.querySelector('iframe');
            if (!iframe) {
                log('❌ No iframe found. Run step 1 first.', 'error');
                return;
            }
            
            const iframeWindow = iframe.contentWindow;
            
            log('Disabling Share Link MCP...', 'info');
            
            if (iframeWindow.MCPShareLinkUI) {
                await iframeWindow.MCPShareLinkUI.disableShareLinkMCP();
                log('✅ Share Link MCP disabled', 'success');
                
                // Check if functions were removed
                const functions = iframeWindow.FunctionToolsService.getJsFunctions();
                const shareLinkFunctions = Object.keys(functions).filter(name => 
                    name.includes('share_link')
                );
                
                if (shareLinkFunctions.length === 0) {
                    log('✅ Share Link functions removed from registry', 'success');
                } else {
                    log(`❌ ${shareLinkFunctions.length} Share Link functions still in registry`, 'error');
                }
            } else {
                log('❌ MCPShareLinkUI not found', 'error');
            }
        }
        
        async function runFullTest() {
            log('=== Starting Full Test ===', 'success');
            results.innerHTML = '';
            
            await enableShareLinkMCP();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            checkFunctionsRegistered();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            openFunctionsModal();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            checkFunctionsInUI();
            
            log('=== Test Complete ===', 'success');
        }
    </script>
</body>
</html>