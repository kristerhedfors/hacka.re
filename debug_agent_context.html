<!DOCTYPE html>
<html>
<head>
    <title>Debug AgentContextManager</title>
</head>
<body>
    <h1>Debug AgentContextManager</h1>
    <button onclick="testAgentContextManager()">Test AgentContextManager</button>
    <div id="output"></div>

    <!-- Load just the essential scripts -->
    <script src="js/services/model-info.js"></script>
    <script src="js/services/encryption-service.js"></script>
    <script src="js/services/storage-type-service.js"></script>
    <script src="js/services/namespace-service.js"></script>
    <script src="js/services/core-storage-service.js"></script>
    <script src="js/services/data-service.js"></script>
    <script src="js/services/storage-service.js"></script>
    <script src="js/services/configuration-service.js"></script>
    <script src="js/services/agent-context-manager.js"></script>
    <script src="js/services/agent-service.js"></script>
    <script src="js/services/agent-cache.js"></script>

    <script>
        function log(message) {
            const output = document.getElementById('output');
            output.innerHTML += '<div>' + message + '</div>';
            console.log(message);
        }

        async function testAgentContextManager() {
            log('🔥 DEBUG: Starting AgentContextManager test...');
            
            // Check if AgentContextManager exists
            if (typeof window.AgentContextManager === 'undefined') {
                log('❌ window.AgentContextManager is undefined');
                return;
            }
            log('✅ window.AgentContextManager exists');

            // Check if AgentService exists
            if (typeof window.AgentService === 'undefined') {
                log('❌ window.AgentService is undefined');
                return;
            }
            log('✅ window.AgentService exists');

            // Check if ConfigurationService exists (required for AgentService.saveAgent)
            if (typeof window.ConfigurationService === 'undefined') {
                log('❌ window.ConfigurationService is undefined - loading it is required');
                return;
            }
            log('✅ window.ConfigurationService exists');

            // Check if AgentCache exists (this might affect differential loading)
            if (typeof window.AgentCache === 'undefined') {
                log('❌ window.AgentCache is undefined');
            } else {
                log('✅ window.AgentCache exists');
            }

            // Create a test agent
            const testConfig = {
                llm: {
                    apiKey: 'test-key',
                    model: 'test-model',
                    provider: 'test-provider'
                },
                prompts: {
                    selectedIds: ['test-prompt']
                }
            };

            // Save the test agent
            log('🔥 DEBUG: Attempting to save test agent...');
            try {
                const saved = window.AgentService.saveAgent('test_agent', testConfig);
                log(`Agent save result: ${saved}`);

                if (!saved) {
                    log('❌ Failed to save test agent');
                    return;
                }
            } catch (error) {
                log(`❌ Error saving agent: ${error.message}`);
                return;
            }

            // Try to apply the agent using applyAgentFast (disable differential loading)
            log('🔥 DEBUG: Calling AgentService.applyAgentFast...');
            try {
                const result = await window.AgentService.applyAgentFast('test_agent', { 
                    silent: false,
                    differential: false,
                    useCache: false
                });
                log(`ApplyAgentFast result: ${result}`);
            } catch (error) {
                log(`❌ Error in applyAgentFast: ${error.message}`);
            }

            // Test direct AgentContextManager call
            log('🔥 DEBUG: Testing direct AgentContextManager.switchToAgent...');
            try {
                const context = window.AgentContextManager.switchToAgent('test_agent', testConfig);
                log(`Direct switchToAgent result: ${context ? 'success' : 'failed'}`);
            } catch (error) {
                log(`❌ Error in direct switchToAgent: ${error.message}`);
            }

            log('🔥 DEBUG: Test completed - check console for debug messages');
        }

        // Auto-run the test on page load
        window.addEventListener('load', () => {
            setTimeout(testAgentContextManager, 1000);
        });
    </script>
</body>
</html>