<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Default Functions</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        pre {
            background: #2d2d2d;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #1177bb;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .info { color: #4fc1ff; }
        .warning { color: #dcdcaa; }
    </style>
</head>
<body>
    <h1>Debug Default Functions</h1>
    
    <button onclick="checkDefaultFunctions()">Check Default Functions State</button>
    <button onclick="enableRC4Functions()">Enable RC4 Functions</button>
    <button onclick="testAPICall()">Test API Call with Functions</button>
    <button onclick="clearConsole()">Clear Console</button>
    
    <pre id="console"></pre>
    
    <script>
        const consoleDiv = document.getElementById('console');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${timestamp}] ${message}`;
            consoleDiv.appendChild(entry);
            console.log(message);
        }
        
        function clearConsole() {
            consoleDiv.innerHTML = '';
        }
        
        async function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        async function initializeApp() {
            log('Loading application scripts...', 'info');
            
            // Load core services first
            const scripts = [
                'js/utils/constants.js',
                'js/services/core-storage-service.js',
                'js/services/encryption-service.js',
                'js/services/namespace-service.js',
                'js/services/storage-service.js',
                'js/services/function-tools-config.js',
                'js/services/function-tools-logger.js',
                'js/services/function-tools-storage.js',
                'js/services/function-tools-parser.js',
                'js/services/function-tools-executor.js',
                'js/services/function-tools-registry.js',
                'js/services/function-tools-processor.js',
                'js/services/function-tools-service.js',
                'js/default-functions/rc4-encryption.js',
                'js/services/default-functions-service.js',
                'js/services/api-tools-service.js',
                'js/components/api-tools-manager.js',
                'js/components/function-calling-manager.js',
                'js/services/chat-tools-service.js'
            ];
            
            for (const script of scripts) {
                try {
                    await loadScript(script);
                    log(`✓ Loaded ${script}`, 'success');
                } catch (error) {
                    log(`✗ Failed to load ${script}: ${error}`, 'error');
                }
            }
            
            log('All scripts loaded', 'success');
            
            // Initialize default functions
            if (window.DefaultFunctionsService) {
                window.DefaultFunctionsService.initializeDefaultFunctions();
                log('Default functions initialized', 'success');
            }
        }
        
        function checkDefaultFunctions() {
            log('\n=== CHECKING DEFAULT FUNCTIONS STATE ===', 'info');
            
            // Check if services are available
            if (!window.DefaultFunctionsService) {
                log('❌ DefaultFunctionsService not available', 'error');
                return;
            }
            
            if (!window.FunctionToolsService) {
                log('❌ FunctionToolsService not available', 'error');
                return;
            }
            
            // Check RC4 functions availability
            if (window.RC4EncryptionFunctions) {
                log('✓ RC4EncryptionFunctions loaded', 'success');
                log(`  - ID: ${window.RC4EncryptionFunctions.id}`, 'info');
                log(`  - Functions: ${window.RC4EncryptionFunctions.functions.map(f => f.name).join(', ')}`, 'info');
            } else {
                log('❌ RC4EncryptionFunctions not loaded', 'error');
            }
            
            // Check selected functions
            const selectedIds = window.DefaultFunctionsService.getSelectedIndividualFunctionIds();
            log(`\nSelected function IDs: ${selectedIds.length > 0 ? selectedIds.join(', ') : 'None'}`, 'info');
            
            // Check enabled default functions
            const enabledDefaultFunctions = window.DefaultFunctionsService.getEnabledDefaultFunctions();
            const enabledNames = Object.keys(enabledDefaultFunctions);
            log(`\nEnabled default functions: ${enabledNames.length > 0 ? enabledNames.join(', ') : 'None'}`, 'info');
            
            // Check if they have tool definitions
            enabledNames.forEach(name => {
                const func = enabledDefaultFunctions[name];
                log(`  - ${name}: has toolDefinition = ${!!func.toolDefinition}`, func.toolDefinition ? 'success' : 'warning');
                if (func.toolDefinition) {
                    log(`    Tool name: ${func.toolDefinition.function?.name}`, 'info');
                }
            });
            
            // Check tool definitions returned for API
            const toolDefinitions = window.DefaultFunctionsService.getEnabledDefaultFunctionToolDefinitions();
            log(`\nTool definitions for API: ${toolDefinitions.length} definitions`, 'info');
            toolDefinitions.forEach(td => {
                log(`  - ${td.function?.name}: ${td.function?.description?.substring(0, 50)}...`, 'info');
            });
            
            // Check function calling manager
            if (window.FunctionCallingManager) {
                const fcManager = window.FunctionCallingManager.createFunctionCallingManager();
                const allDefinitions = fcManager.getFunctionDefinitions();
                log(`\nFunction Calling Manager tool definitions: ${allDefinitions.length} total`, 'info');
                allDefinitions.forEach(td => {
                    log(`  - ${td.function?.name}`, 'info');
                });
            }
            
            // Check if function tools are globally enabled
            const globallyEnabled = window.FunctionToolsService.isFunctionToolsEnabled();
            log(`\nFunction tools globally enabled: ${globallyEnabled}`, globallyEnabled ? 'success' : 'warning');
        }
        
        function enableRC4Functions() {
            log('\n=== ENABLING RC4 FUNCTIONS ===', 'info');
            
            if (!window.DefaultFunctionsService) {
                log('❌ DefaultFunctionsService not available', 'error');
                return;
            }
            
            // Enable RC4 functions
            const rc4FunctionIds = [
                'rc4-encryption:rc4_encrypt',
                'rc4-encryption:rc4_decrypt'
            ];
            
            rc4FunctionIds.forEach(id => {
                const wasSelected = window.DefaultFunctionsService.isIndividualFunctionSelected(id);
                if (!wasSelected) {
                    window.DefaultFunctionsService.toggleIndividualFunctionSelection(id);
                    log(`✓ Enabled ${id}`, 'success');
                } else {
                    log(`Already enabled: ${id}`, 'info');
                }
            });
            
            // Ensure function tools are globally enabled
            if (window.FunctionToolsService && !window.FunctionToolsService.isFunctionToolsEnabled()) {
                window.FunctionToolsService.setFunctionToolsEnabled(true);
                log('✓ Enabled function tools globally', 'success');
            }
            
            // Load the selected functions
            window.DefaultFunctionsService.loadSelectedDefaultFunctions();
            log('✓ Loaded selected default functions', 'success');
            
            // Check the state again
            checkDefaultFunctions();
        }
        
        async function testAPICall() {
            log('\n=== TESTING API CALL WITH FUNCTIONS ===', 'info');
            
            // Check if we have an API key
            const apiKey = localStorage.getItem('openai_api_key');
            if (!apiKey) {
                log('❌ No API key found. Please set an OpenAI API key first.', 'error');
                return;
            }
            
            // Create a combined tools manager
            const apiToolsManager = window.ApiToolsManager ? 
                window.ApiToolsManager.createApiToolsManager() : null;
            const functionCallingManager = window.FunctionCallingManager ? 
                window.FunctionCallingManager.createFunctionCallingManager() : null;
            const combinedToolsManager = window.ChatToolsService ? 
                window.ChatToolsService.createCombinedToolsManager(apiToolsManager, functionCallingManager) : null;
            
            if (!combinedToolsManager) {
                log('❌ Could not create combined tools manager', 'error');
                return;
            }
            
            // Get tool definitions
            const toolDefinitions = combinedToolsManager.getEnabledToolDefinitions();
            log(`Tool definitions to be sent: ${toolDefinitions.length}`, 'info');
            toolDefinitions.forEach(td => {
                log(`  - ${td.function?.name}: ${td.function?.description?.substring(0, 50)}...`, 'info');
            });
            
            // Build a test API request
            const requestBody = {
                model: 'gpt-4o-mini',
                messages: [
                    { role: 'system', content: 'You are a helpful assistant.' },
                    { role: 'user', content: 'Encrypt the text "Hello World" using RC4 with key "secret"' }
                ],
                tools: toolDefinitions,
                tool_choice: 'auto',
                stream: false
            };
            
            log('\nSending API request...', 'info');
            log(`Request includes ${requestBody.tools.length} tool definitions`, 'info');
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log('✓ API call successful', 'success');
                    
                    if (data.choices && data.choices[0]) {
                        const choice = data.choices[0];
                        if (choice.message.tool_calls) {
                            log(`✓ Model made ${choice.message.tool_calls.length} tool call(s)`, 'success');
                            choice.message.tool_calls.forEach(tc => {
                                log(`  - Called: ${tc.function.name}`, 'success');
                                log(`    Args: ${tc.function.arguments}`, 'info');
                            });
                        } else {
                            log('❌ Model did not make any tool calls', 'warning');
                            log(`Response: ${choice.message.content}`, 'info');
                        }
                    }
                } else {
                    log(`❌ API call failed: ${data.error?.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`❌ Error making API call: ${error.message}`, 'error');
            }
        }
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>