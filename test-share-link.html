<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Link Test</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #0f0;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            border: 1px solid #0f0;
            padding: 15px;
            margin: 20px 0;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0a0;
        }
        pre {
            background: #000;
            padding: 10px;
            overflow-x: auto;
        }
        .success { color: #0f0; }
        .error { color: #f00; }
        .warning { color: #ff0; }
    </style>
</head>
<body>
    <h1>Share Link Functionality Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Check Default Function Services</h2>
        <button onclick="testDefaultFunctions()">Test Default Functions</button>
        <pre id="default-functions-result"></pre>
    </div>

    <div class="test-section">
        <h2>Test 2: Check Default Prompts Services</h2>
        <button onclick="testDefaultPrompts()">Test Default Prompts</button>
        <pre id="default-prompts-result"></pre>
    </div>

    <div class="test-section">
        <h2>Test 3: Simulate Share Link Generation</h2>
        <button onclick="testShareGeneration()">Test Share Generation</button>
        <pre id="share-generation-result"></pre>
    </div>

    <div class="test-section">
        <h2>Test 4: Full Share Link Test</h2>
        <button onclick="testFullShareLink()">Test Full Share Link</button>
        <pre id="full-share-result"></pre>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            element.innerHTML += `<span class="${className}">${message}\n</span>`;
        }

        function testDefaultFunctions() {
            const resultId = 'default-functions-result';
            document.getElementById(resultId).innerHTML = '';
            
            try {
                log(resultId, '=== Testing Default Functions Service ===', 'info');
                
                if (!window.DefaultFunctionsService) {
                    log(resultId, '❌ DefaultFunctionsService not found', 'error');
                    return;
                }
                
                // Test getting collections
                const collections = window.DefaultFunctionsService.getDefaultFunctionCollections();
                log(resultId, `✅ Found ${collections.length} default function collections`, 'success');
                collections.forEach(c => {
                    log(resultId, `  - ${c.id}: ${c.name} (${c.functions.length} functions)`);
                });
                
                // Test getting selected collection IDs
                const selectedCollectionIds = window.DefaultFunctionsService.getSelectedDefaultFunctionIds();
                log(resultId, `\n✅ Selected collection IDs: ${JSON.stringify(selectedCollectionIds)}`, 'success');
                
                // Test getting selected individual function IDs
                const selectedIndividualIds = window.DefaultFunctionsService.getSelectedIndividualFunctionIds();
                log(resultId, `✅ Selected individual function IDs: ${JSON.stringify(selectedIndividualIds)}`, 'success');
                
            } catch (error) {
                log(resultId, `❌ Error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function testDefaultPrompts() {
            const resultId = 'default-prompts-result';
            document.getElementById(resultId).innerHTML = '';
            
            try {
                log(resultId, '=== Testing Default Prompts Service ===', 'info');
                
                if (!window.DefaultPromptsService) {
                    log(resultId, '❌ DefaultPromptsService not found', 'error');
                    return;
                }
                
                // Test getting prompts
                const prompts = window.DefaultPromptsService.getDefaultPrompts();
                log(resultId, `✅ Found ${prompts.length} default prompts`, 'success');
                prompts.forEach(p => {
                    log(resultId, `  - ${p.id}: ${p.name}`);
                });
                
                // Test getting selected prompt IDs
                const selectedPromptIds = window.DefaultPromptsService.getSelectedDefaultPromptIds();
                log(resultId, `\n✅ Selected default prompt IDs: ${JSON.stringify(selectedPromptIds)}`, 'success');
                
                // Check for MCP prompts
                const mcpPromptIds = ['shodan-integration-guide', 'github-integration-guide', 'gmail-integration-guide'];
                const filteredIds = selectedPromptIds.filter(id => !mcpPromptIds.includes(id));
                log(resultId, `✅ Non-MCP selected prompts: ${JSON.stringify(filteredIds)}`, 'success');
                
            } catch (error) {
                log(resultId, `❌ Error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function testShareGeneration() {
            const resultId = 'share-generation-result';
            document.getElementById(resultId).innerHTML = '';
            
            try {
                log(resultId, '=== Testing Share Generation Logic ===', 'info');
                
                // Simulate share options
                const options = {
                    includePromptLibrary: true,
                    includeFunctionLibrary: true
                };
                
                log(resultId, '\nOptions: ' + JSON.stringify(options, null, 2));
                
                // Test collecting prompts
                if (window.PromptsService) {
                    const allPrompts = window.PromptsService.getPrompts();
                    const userPrompts = allPrompts.filter(p => !p.isMcpPrompt);
                    log(resultId, `\nUser prompts (excluding MCP): ${userPrompts.length}`);
                    
                    const selectedPromptIds = window.PromptsService.getSelectedPromptIds();
                    log(resultId, `Selected prompt IDs: ${JSON.stringify(selectedPromptIds)}`);
                }
                
                // Test collecting functions
                if (window.FunctionToolsService) {
                    const allFunctions = window.FunctionToolsService.getJsFunctions();
                    log(resultId, `\nTotal functions: ${Object.keys(allFunctions).length}`);
                    
                    // Check for MCP functions
                    const collections = window.FunctionToolsService.getAllFunctionCollections();
                    const mcpCollections = Object.values(collections).filter(c => 
                        c.metadata.source === 'mcp' || c.id.startsWith('mcp_')
                    );
                    log(resultId, `MCP collections: ${mcpCollections.length}`);
                    
                    const functionCollections = window.FunctionToolsService.getFunctionCollections();
                    const userFunctions = {};
                    Object.entries(allFunctions).forEach(([name, spec]) => {
                        const collectionId = functionCollections[name];
                        if (!collectionId || !mcpCollections.find(c => c.id === collectionId)) {
                            userFunctions[name] = spec;
                        }
                    });
                    log(resultId, `User functions (excluding MCP): ${Object.keys(userFunctions).length}`);
                }
                
                // Test default selections
                if (window.DefaultPromptsService) {
                    const defaultPromptIds = window.DefaultPromptsService.getSelectedDefaultPromptIds();
                    log(resultId, `\nSelected default prompts: ${JSON.stringify(defaultPromptIds)}`, 'success');
                }
                
                if (window.DefaultFunctionsService) {
                    const defaultFunctionIds = window.DefaultFunctionsService.getSelectedDefaultFunctionIds();
                    const individualFunctionIds = window.DefaultFunctionsService.getSelectedIndividualFunctionIds();
                    log(resultId, `Selected default function collections: ${JSON.stringify(defaultFunctionIds)}`, 'success');
                    log(resultId, `Selected individual default functions: ${JSON.stringify(individualFunctionIds)}`, 'success');
                }
                
            } catch (error) {
                log(resultId, `❌ Error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function testFullShareLink() {
            const resultId = 'full-share-result';
            document.getElementById(resultId).innerHTML = '';
            
            try {
                log(resultId, '=== Testing Full Share Link Generation ===', 'info');
                
                if (!window.ShareService) {
                    log(resultId, '❌ ShareService not found', 'error');
                    return;
                }
                
                // Create test options
                const options = {
                    password: 'test123',
                    includeBaseUrl: true,
                    baseUrl: 'https://api.openai.com/v1',
                    includeApiKey: false,
                    includeModel: true,
                    model: 'gpt-4',
                    includePromptLibrary: true,
                    includeFunctionLibrary: true,
                    includeRagSettings: false
                };
                
                log(resultId, 'Test options: ' + JSON.stringify(options, null, 2));
                
                // Generate share link
                const link = await window.ShareService.createShareLink(options);
                log(resultId, `\n✅ Generated link (${link.length} chars)`, 'success');
                
                // Extract and verify the data
                if (link.includes('#gpt=')) {
                    const hashPart = link.split('#gpt=')[1];
                    log(resultId, `Hash length: ${hashPart.length} chars`);
                    
                    // Try to decrypt (would need password)
                    log(resultId, '\n⚠️ Link contains encrypted data (password required to decrypt)', 'warning');
                } else {
                    log(resultId, '⚠️ No encrypted data in link', 'warning');
                }
                
            } catch (error) {
                log(resultId, `❌ Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>