# Pre-cached Embeddings for RAG

This document describes the pre-cached embeddings system for RAG (Retrieval-Augmented Generation) functionality in hacka.re.

## Overview

Pre-cached embeddings allow the RAG system to function without requiring API calls to generate embeddings for commonly used documents. This provides:

- **Faster initialization** - No need to generate embeddings on first use
- **Reduced API costs** - Embeddings are pre-computed during build time
- **Offline capability** - Basic RAG functionality works without internet connection
- **Better performance** - No delay for embedding generation

## Architecture

### Components

1. **Build Scripts** (`scripts/`)
   - `build_precached_embeddings.js` - Production build script (requires OpenAI API key)
   - `generate_realistic_test_embeddings.js` - Test script with mock embeddings
   - `generate_test_embeddings_simple.js` - Simple test data generator

2. **Pre-cached Data** (`js/data/`)
   - `precached-embeddings-realistic.js` - Test file with real chunks and mock embeddings
   - `precached-embeddings.js` - Production file with real embeddings (generated by build script)

3. **Integration Points**
   - `js/components/rag/rag-coordinator.js` - Vector store management
   - `js/services/vector-rag-service.js` - Search functionality
   - `index.html` - Loads pre-cached embeddings file

## How It Works

### 1. Build Time
```bash
# Ensure API key is in _tests/playwright/.env file
# Format: OPENAI_API_KEY=sk-proj-...

# Generate pre-cached embeddings (reads API key from .env)
node scripts/build_precached_embeddings.js
```

The build script:
- Reads OpenAI API key from `_tests/playwright/.env`
- Loads EU regulation documents (AI Act, CRA, DORA)
- Chunks text into ~512 token segments with 50 token overlap
- Generates embeddings using OpenAI's `text-embedding-3-small` model
- Saves embeddings to a JavaScript file

### 2. Runtime Loading

When the application loads:
1. Pre-cached embeddings file is loaded via `<script>` tag
2. `initializePrecachedEmbeddings()` function runs automatically
3. Vectors are stored in `window.ragVectorStore`
4. Document metadata is updated in localStorage

### 3. Search Process

With pre-cached embeddings:
- **With API key**: Full vector search with query embedding generation
- **Without API key**: Text-based fallback search still works
- Cosine similarity calculations use pre-cached vectors

## File Format

```javascript
window.precachedEmbeddings = {
    version: "1.0",
    generatedAt: "ISO timestamp",
    model: "text-embedding-3-small",
    config: {
        chunkSize: 512,
        chunkOverlap: 50
    },
    documents: [{
        documentId: "aia",
        documentName: "EU AI Act",
        vectors: [{
            id: "aia_chunk_0",
            embedding: [/* 1536 dimensions */],
            position: { start: 0, end: 2048 },
            metadata: { /* chunk metadata */ }
        }],
        metadata: { /* document metadata */ }
    }]
}
```

## Testing

### Unit Tests
```bash
# Run pre-cached embeddings tests
_venv/bin/python -m pytest _tests/playwright/test_precached_embeddings.py -v
```

Tests verify:
- Embeddings load on startup
- Search works without API key
- Cosine similarity calculations
- Memory efficiency
- Chat integration

### Test Data

For development/testing, use mock embeddings:
```bash
# Generate test embeddings (no API key needed)
node scripts/generate_realistic_test_embeddings.js
```

This creates smaller (50-dimension) mock embeddings for testing.

## Configuration

### Including Pre-cached Embeddings

In `index.html`:
```html
<!-- Pre-cached embeddings for RAG -->
<script src="js/data/precached-embeddings.js"></script>
```

### Selecting Documents

Edit `scripts/build_precached_embeddings.js` to configure:
- Which documents to include
- Chunk size and overlap
- Embedding model
- Output location

## Performance Considerations

### Memory Usage
- ~30 chunks × 1536 dimensions × 4 bytes = ~180KB per document
- 3 documents ≈ 540KB total memory
- Stored in memory, not localStorage (avoids quota issues)

### Load Time
- Pre-cached file is ~2-3MB (compressed to ~500KB with gzip)
- Loads once on application startup
- No runtime generation needed

## Future Enhancements

1. **Incremental Updates**
   - Add new documents without regenerating all embeddings
   - Version management for embeddings

2. **Compression**
   - Quantization to reduce embedding size
   - Binary format instead of JSON

3. **Selective Loading**
   - Load embeddings on-demand per document
   - Progressive enhancement based on usage

4. **Additional Documents**
   - Pre-cache default prompts
   - Include user-uploaded documents
   - Support for more regulation documents

## Troubleshooting

### Embeddings Not Loading
1. Check browser console for errors
2. Verify file is included in index.html
3. Ensure `window.ragVectorStore` exists
4. Check `window.precachedEmbeddings` is defined

### Search Not Working
1. Verify embeddings are loaded: `window.ragVectorStore.getDocumentIds()`
2. Check if API key is set for query embedding
3. Review console for RAG service errors

### Memory Issues
1. Monitor browser memory usage
2. Consider reducing chunk count
3. Implement pagination for large documents

## API Reference

### Global Functions

```javascript
// Initialize pre-cached embeddings
window.initializePrecachedEmbeddings()
// Returns: boolean (success/failure)

// Check if embeddings are loaded
window.ragVectorStore.hasVectors(documentId)
// Returns: boolean

// Get vectors for a document
window.ragVectorStore.getVectors(documentId)
// Returns: array of vector objects
```

### Vector Store Methods

```javascript
// Store vectors
ragVectorStore.storeVectors(docId, vectors, metadata)

// Get document IDs
ragVectorStore.getDocumentIds()

// Clear document vectors
ragVectorStore.clearDocument(docId)
```

## Setup and Configuration

### API Key Configuration

The build script reads the OpenAI API key from `_tests/playwright/.env`:

```bash
# Copy the example file if you haven't already
cp _tests/playwright/.env.example _tests/playwright/.env

# Edit the file and add your API key
# OPENAI_API_KEY=sk-proj-your-key-here
```

### Building Production Embeddings

```bash
# From project root
node scripts/build_precached_embeddings.js
```

This will:
1. Read API key from `_tests/playwright/.env`
2. Generate real embeddings using OpenAI API
3. Save to `js/data/precached-embeddings.js`

## Contributing

When adding new documents for pre-caching:

1. Add document to `regulations` array in build script
2. Ensure document has extractable content
3. Ensure API key is in `_tests/playwright/.env`
4. Run build script: `node scripts/build_precached_embeddings.js`
5. Test with unit tests
6. Update this documentation

## License

Pre-cached embeddings are generated from public EU regulation documents and are provided for educational and development purposes.